<!DOCTYPE html>
<html lang="en" style="color-scheme: dark;">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#0a0a0f">
<title>tsp - tmux super powers</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600&family=JetBrains+Mono:wght@400;500&family=Syne:wght@700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-base: #0a0a0f;
    --bg-deep: #12121a;
    --bg-surface: #1a1a2e;
    --bg-elevated: #1e1e30;
    --bg-input: #252540;
    --border: #2a2a45;
    --border-hover: #3a3a5a;
    --cyan: #00e5ff;
    --green: #39ff14;
    --amber: #ffab00;
    --red: #ff1744;
    --blue: #448aff;
    --purple: #b388ff;
    --text: #f0f0f5;
    --text-muted: #8888aa;
    --text-dim: #555570;
    --radius: 10px;
    --font-display: 'Syne', sans-serif;
    --font-body: 'IBM Plex Sans', sans-serif;
    --font-mono: 'JetBrains Mono', monospace;
  }
  *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
  .skip-link { position: absolute; top: -100%; left: 16px; z-index: 999; padding: 8px 16px; background: var(--cyan); color: var(--bg-base); font-family: var(--font-body); font-size: 14px; font-weight: 600; border-radius: 0 0 8px 8px; text-decoration: none; transition: top 0.15s; }
  .skip-link:focus { top: 0; }
  .visually-hidden { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }
  body { font-family: var(--font-body); background: var(--bg-base); color: var(--text); min-height: 100vh; line-height: 1.6; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E"); -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
  header { background: var(--bg-deep); padding: 14px 28px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid transparent; box-shadow: 0 1px 0 0 var(--border), 0 4px 24px rgba(0, 229, 255, 0.04); }
  header h1 { font-family: var(--font-display); font-size: 20px; font-weight: 800; letter-spacing: -0.5px; text-wrap: balance; }
  header h1 span { color: var(--cyan); }
  .health-bar { display: flex; gap: 18px; align-items: center; font-size: 13px; font-weight: 500; color: var(--text-muted); }
  .health-item { display: flex; align-items: center; gap: 7px; }
  .health-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; transition: background-color 0.3s, box-shadow 0.3s; }
  .health-dot.ok { background: var(--green); box-shadow: 0 0 6px rgba(57, 255, 20, 0.5); }
  .health-dot.fail { background: var(--red); box-shadow: 0 0 6px rgba(255, 23, 68, 0.5); }
  .ws-status { font-size: 12px; color: var(--text-dim); display: flex; align-items: center; gap: 5px; font-family: var(--font-mono); font-weight: 400; }
  .ws-dot { width: 6px; height: 6px; border-radius: 50%; display: inline-block; transition: background-color 0.3s, box-shadow 0.3s; }
  .ws-dot.connected { background: var(--green); box-shadow: 0 0 4px rgba(57, 255, 20, 0.5); animation: pulse-green 2s ease-in-out infinite; }
  .ws-dot.disconnected { background: var(--red); box-shadow: 0 0 4px rgba(255, 23, 68, 0.5); }
  @keyframes pulse-green { 0%, 100% { box-shadow: 0 0 4px rgba(57, 255, 20, 0.5); } 50% { box-shadow: 0 0 10px rgba(57, 255, 20, 0.7); } }
  main { max-width: 1100px; margin: 0 auto; padding: 28px 24px 60px; }
  .tabs { display: flex; gap: 2px; margin-bottom: 24px; border-bottom: 1px solid var(--border); padding-bottom: 0; position: relative; }
  .tab { padding: 10px 20px; background: none; border: none; color: var(--text-dim); cursor: pointer; font-family: var(--font-body); font-size: 14px; font-weight: 500; border-bottom: 2px solid transparent; margin-bottom: -1px; transition: color 0.2s, border-bottom-color 0.2s; touch-action: manipulation; }
  .tab:hover { color: var(--text-muted); }
  .tab.active { color: var(--cyan); border-bottom-color: var(--cyan); }
  .tab:focus-visible { outline: 2px solid var(--cyan); outline-offset: -2px; border-radius: 4px 4px 0 0; }
  .tab-content { display: none; }
  .tab-content.active { display: block; animation: fadeIn 0.25s ease; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }
  .session-grid { display: grid; gap: 12px; }
  .session-card { background: var(--bg-elevated); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; transition: border-color 0.2s, box-shadow 0.2s; }
  .session-card:hover { border-color: var(--border-hover); box-shadow: 0 0 20px rgba(0, 229, 255, 0.04); }
  .session-header { padding: 16px 18px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; user-select: none; }
  .session-header:focus-visible { outline: 2px solid var(--cyan); outline-offset: -2px; }
  .session-left { display: flex; align-items: center; gap: 14px; flex: 1; min-width: 0; }
  .status-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; transition: background-color 0.3s, box-shadow 0.3s; }
  .status-dot.active { background: var(--green); box-shadow: 0 0 8px rgba(57, 255, 20, 0.5); animation: pulse-status-green 2.5s ease-in-out infinite; }
  .status-dot.idle { background: var(--amber); box-shadow: 0 0 8px rgba(255, 171, 0, 0.4); }
  .status-dot.done { background: var(--blue); box-shadow: 0 0 8px rgba(68, 138, 255, 0.4); }
  .status-dot.error { background: var(--red); box-shadow: 0 0 8px rgba(255, 23, 68, 0.4); animation: pulse-status-red 1.5s ease-in-out infinite; }
  @keyframes pulse-status-green { 0%, 100% { box-shadow: 0 0 8px rgba(57, 255, 20, 0.5); } 50% { box-shadow: 0 0 14px rgba(57, 255, 20, 0.7); } }
  @keyframes pulse-status-red { 0%, 100% { box-shadow: 0 0 8px rgba(255, 23, 68, 0.4); } 50% { box-shadow: 0 0 14px rgba(255, 23, 68, 0.7); } }
  .session-name { font-family: var(--font-mono); font-weight: 500; font-size: 15px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text); }
  .session-meta { display: flex; gap: 18px; color: var(--text-dim); font-size: 13px; flex-shrink: 0; font-variant-numeric: tabular-nums; }
  .session-meta .branch { color: var(--purple); font-family: var(--font-mono); font-size: 12px; }
  .session-detail { display: none; border-top: 1px solid var(--border); padding: 18px; background: var(--bg-surface); }
  .session-card.expanded .session-detail { display: block; }
  .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; margin-bottom: 16px; }
  @media (max-width: 700px) { .detail-grid { grid-template-columns: 1fr; } }
  .detail-section h4 { font-family: var(--font-body); font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-dim); margin-bottom: 10px; font-weight: 600; text-wrap: balance; }
  .pane-list { display: flex; flex-direction: column; gap: 6px; }
  .pane-item { background: var(--bg-deep); border: 1px solid var(--border); border-radius: 6px; padding: 8px 12px; font-size: 13px; display: flex; justify-content: space-between; font-family: var(--font-mono); font-weight: 400; }
  .pane-type { color: var(--cyan); }
  .pane-process { color: var(--text-dim); }
  .pr-info { background: var(--bg-deep); border: 1px solid var(--border); border-radius: 6px; padding: 12px; font-size: 13px; }
  .pr-info a { color: var(--blue); text-decoration: none; font-weight: 500; transition: color 0.15s; }
  .pr-info a:hover { text-decoration: underline; color: var(--cyan); }
  .pr-info a:focus-visible { outline: 2px solid var(--cyan); outline-offset: 2px; border-radius: 2px; }
  .pr-detail { margin-top: 6px; color: var(--text-dim); font-size: 12px; }
  .diff-stats { display: flex; gap: 14px; font-size: 13px; margin-top: 10px; font-family: var(--font-mono); font-variant-numeric: tabular-nums; }
  .diff-files { color: var(--text-dim); }
  .diff-ins { color: var(--green); }
  .diff-del { color: var(--red); }
  .actions-row { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 14px; padding-top: 14px; border-top: 1px solid var(--border); }
  .btn { padding: 7px 16px; border: 1px solid var(--border); border-radius: 20px; background: var(--bg-input); color: var(--text); font-family: var(--font-body); font-size: 13px; font-weight: 500; cursor: pointer; transition: background-color 0.15s, border-color 0.15s, color 0.15s, box-shadow 0.15s; white-space: nowrap; touch-action: manipulation; }
  .btn:hover { background: var(--bg-surface); border-color: var(--border-hover); }
  .btn:focus-visible { outline: 2px solid var(--cyan); outline-offset: 2px; }
  .btn:disabled { opacity: 0.35; cursor: not-allowed; }
  .btn.danger { border-color: rgba(255, 23, 68, 0.4); color: var(--red); }
  .btn.danger:hover { background: rgba(255, 23, 68, 0.1); border-color: var(--red); }
  .btn.primary { background: var(--cyan); color: var(--bg-base); border-color: var(--cyan); font-weight: 600; }
  .btn.primary:hover { background: #33ebff; box-shadow: 0 0 16px rgba(0, 229, 255, 0.25); }
  .btn-sm { padding: 5px 12px; font-size: 12px; }
  .send-row { display: flex; gap: 8px; margin-top: 14px; align-items: center; }
  .send-row select, .send-row input { padding: 7px 12px; border: 1px solid var(--border); border-radius: 8px; background-color: var(--bg-input); color: var(--text); font-family: var(--font-mono); font-size: 13px; transition: border-color 0.15s, box-shadow 0.15s; }
  .send-row input { flex: 1; }
  .send-row select { width: 100px; }
  .send-row input:focus-visible, .send-row select:focus-visible { outline: 2px solid var(--cyan); outline-offset: -1px; border-color: var(--cyan); box-shadow: 0 0 0 2px rgba(0, 229, 255, 0.12); }
  .send-row input:focus:not(:focus-visible), .send-row select:focus:not(:focus-visible) { outline: none; border-color: var(--cyan); box-shadow: 0 0 0 2px rgba(0, 229, 255, 0.12); }
  .form-panel { background: var(--bg-elevated); border: 1px solid var(--border); border-radius: var(--radius); padding: 28px; max-width: 600px; }
  .form-panel h3 { font-family: var(--font-display); font-size: 20px; font-weight: 700; margin-bottom: 20px; text-wrap: balance; }
  .form-group { margin-bottom: 16px; }
  .form-group label { display: block; font-size: 13px; color: var(--text-muted); margin-bottom: 6px; font-weight: 500; }
  .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px 14px; border: 1px solid var(--border); border-radius: 8px; background-color: var(--bg-input); color: var(--text); font-family: var(--font-body); font-size: 14px; transition: border-color 0.15s, box-shadow 0.15s; }
  .form-group textarea { resize: vertical; min-height: 80px; }
  .form-group input:focus-visible, .form-group textarea:focus-visible, .form-group select:focus-visible { outline: 2px solid var(--cyan); outline-offset: -1px; border-color: var(--cyan); box-shadow: 0 0 0 2px rgba(0, 229, 255, 0.12); }
  .form-group input:focus:not(:focus-visible), .form-group textarea:focus:not(:focus-visible), .form-group select:focus:not(:focus-visible) { outline: none; border-color: var(--cyan); box-shadow: 0 0 0 2px rgba(0, 229, 255, 0.12); }
  .form-hint { font-size: 12px; color: var(--text-dim); margin-top: 4px; }
  .task-list { display: flex; flex-direction: column; gap: 8px; }
  .task-row { display: flex; gap: 10px; align-items: center; }
  .task-row textarea { flex: 1; padding: 10px 14px; border: 1px solid var(--border); border-radius: 8px; background-color: var(--bg-input); color: var(--text); font-family: var(--font-body); font-size: 14px; resize: vertical; min-height: 60px; transition: border-color 0.15s, box-shadow 0.15s; }
  .task-row textarea:focus-visible { outline: 2px solid var(--cyan); outline-offset: -1px; border-color: var(--cyan); box-shadow: 0 0 0 2px rgba(0, 229, 255, 0.12); }
  .task-row textarea:focus:not(:focus-visible) { outline: none; border-color: var(--cyan); box-shadow: 0 0 0 2px rgba(0, 229, 255, 0.12); }
  .task-row .task-num { font-family: var(--font-mono); font-size: 12px; color: var(--text-dim); font-weight: 500; width: 24px; text-align: center; flex-shrink: 0; font-variant-numeric: tabular-nums; }
  .task-row .btn-remove { padding: 4px 8px; font-size: 18px; line-height: 1; color: var(--text-dim); background: none; border: 1px solid transparent; border-radius: 6px; cursor: pointer; flex-shrink: 0; transition: color 0.15s, border-color 0.15s; touch-action: manipulation; }
  .task-row .btn-remove:hover { color: var(--red); border-color: var(--red); }
  .task-row .btn-remove:focus-visible { outline: 2px solid var(--cyan); outline-offset: 2px; }
  .add-task-btn { display: flex; align-items: center; gap: 6px; padding: 10px 14px; margin-top: 6px; background: none; border: 1px dashed var(--border); border-radius: 8px; color: var(--text-dim); cursor: pointer; font-family: var(--font-body); font-size: 13px; font-weight: 500; width: 100%; justify-content: center; transition: border-color 0.2s, color 0.2s; touch-action: manipulation; }
  .add-task-btn:hover { border-color: var(--cyan); color: var(--cyan); }
  .add-task-btn:focus-visible { outline: 2px solid var(--cyan); outline-offset: 2px; }
  .spawn-results { margin-top: 18px; border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
  .spawn-results h4 { padding: 12px 16px; background: var(--bg-deep); font-family: var(--font-body); font-size: 11px; font-weight: 600; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; text-wrap: balance; }
  .spawn-result-item { padding: 12px 16px; border-top: 1px solid var(--border); display: flex; align-items: center; gap: 12px; font-size: 13px; }
  .spawn-result-item .result-status { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
  .spawn-result-item .result-status.ok { background: var(--green); box-shadow: 0 0 6px rgba(57, 255, 20, 0.4); }
  .spawn-result-item .result-status.error { background: var(--red); box-shadow: 0 0 6px rgba(255, 23, 68, 0.4); }
  .spawn-result-item .result-task { flex: 1; }
  .spawn-result-item .result-branch { color: var(--purple); font-family: var(--font-mono); font-size: 12px; }
  .spawn-result-item .result-session { color: var(--cyan); font-family: var(--font-mono); font-size: 12px; }
  .spawn-result-item .result-error { color: var(--red); font-size: 12px; }
  .toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 200; display: flex; flex-direction: column; gap: 10px; }
  .toast { background: rgba(30, 30, 48, 0.85); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid var(--border); border-radius: var(--radius); padding: 12px 18px; font-size: 13px; font-weight: 500; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5); animation: toastSlide 0.3s ease; max-width: 380px; }
  .toast.success { border-left: 3px solid var(--green); }
  .toast.error { border-left: 3px solid var(--red); }
  .toast.info { border-left: 3px solid var(--blue); }
  @keyframes toastSlide { from { transform: translateX(100%) scale(0.95); opacity: 0; } to { transform: translateX(0) scale(1); opacity: 1; } }
  .empty-state { text-align: center; padding: 80px 24px; color: var(--text-dim); }
  .empty-state h3 { font-family: var(--font-display); font-size: 18px; font-weight: 700; color: var(--text-muted); margin-bottom: 10px; text-wrap: balance; }
  .spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid var(--border); border-top-color: var(--cyan); border-radius: 50%; animation: spin 0.6s linear infinite; vertical-align: middle; margin-right: 6px; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .pairing-wrapper { display: flex; align-items: center; justify-content: center; min-height: calc(100vh - 60px); padding: 24px; }
  .pairing-panel { text-align: center; max-width: 420px; position: relative; }
  .pairing-panel::before { content: ''; position: absolute; inset: -1px; border-radius: var(--radius); background: linear-gradient(135deg, rgba(0, 229, 255, 0.08), transparent 60%); pointer-events: none; z-index: 0; }
  .pairing-panel .form-panel { position: relative; z-index: 1; max-width: none; }
  .pairing-title { font-family: var(--font-display); font-size: 22px; font-weight: 800; margin-bottom: 8px; text-wrap: balance; }
  .pairing-subtitle { color: var(--text-muted); font-size: 14px; margin-bottom: 28px; line-height: 1.6; }
  .pairing-subtitle code { background: var(--bg-deep); padding: 3px 8px; border-radius: 5px; font-family: var(--font-mono); font-size: 13px; color: var(--cyan); border: 1px solid var(--border); }
  .pairing-code-input { text-align: center; font-family: var(--font-mono) !important; font-size: 28px !important; letter-spacing: 8px; text-transform: uppercase; font-weight: 500 !important; padding: 14px 16px !important; }
  .pairing-btn { width: 100%; padding: 12px !important; font-size: 15px !important; border-radius: 20px !important; }
  .pairing-error { color: var(--red); font-size: 13px; margin-top: 14px; display: none; }
  .pairing-panel::after { content: ''; position: absolute; inset: 0; background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0, 229, 255, 0.01) 2px, rgba(0, 229, 255, 0.01) 4px); pointer-events: none; border-radius: var(--radius); z-index: 2; }
  input[type="checkbox"] { accent-color: var(--cyan); width: 16px; height: 16px; cursor: pointer; }
  input[type="checkbox"]:focus-visible { outline: 2px solid var(--cyan); outline-offset: 2px; }
  @media (prefers-reduced-motion: reduce) { *, *::before, *::after { animation-duration: 0.001ms !important; animation-iteration-count: 1 !important; transition-duration: 0.001ms !important; } }
  ::-webkit-scrollbar { width: 8px; }
  ::-webkit-scrollbar-track { background: var(--bg-base); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--border-hover); }
  ::selection { background: rgba(0, 229, 255, 0.2); color: var(--text); }
</style>
</head>
<body>
<a href="#main-content" class="skip-link">Skip to main content</a>
<header>
  <h1><span>tsp</span> test console</h1>
  <nav class="health-bar" aria-label="System status">
    <div class="health-item">
      <span class="health-dot" id="healthTmux" role="status" aria-label="tmux status"></span>
      <span>tmux</span>
    </div>
    <div class="health-item">
      <span class="health-dot" id="healthGh" role="status" aria-label="gh CLI status"></span>
      <span>gh</span>
    </div>
    <div class="ws-status">
      <span class="ws-dot" id="wsDot" role="status" aria-label="WebSocket connection status"></span>
      <span id="wsLabel">connecting</span>
    </div>
  </nav>
</header>
<main id="main-content">
  <div class="tabs" role="tablist" aria-label="Main navigation">
    <button class="tab active" data-tab="sessions" role="tab" aria-selected="true" aria-controls="tab-sessions">Sessions</button>
    <button class="tab" data-tab="create" role="tab" aria-selected="false" aria-controls="tab-create">Create</button>
    <button class="tab" data-tab="spawn" role="tab" aria-selected="false" aria-controls="tab-spawn">Spawn</button>
  </div>
  <section class="tab-content active" id="tab-sessions" role="tabpanel" aria-labelledby="tab-sessions-label">
    <h2 class="visually-hidden" id="tab-sessions-label">Active Sessions</h2>
    <div class="session-grid" id="sessionGrid"></div>
    <div class="empty-state" id="emptyState">
      <h3>No sessions</h3>
      <p>Start a tmux session or use the Create / Spawn tabs.</p>
    </div>
  </section>
  <section class="tab-content" id="tab-create" role="tabpanel" aria-labelledby="tab-create-label">
    <h2 class="visually-hidden" id="tab-create-label">Create Session</h2>
    <div class="form-panel">
      <h3>Create Session</h3>
      <div class="form-group">
        <label for="createName">Session name</label>
        <input type="text" id="createName" name="sessionName" placeholder="my-session" autocomplete="off" spellcheck="false">
      </div>
      <div class="form-group">
        <label for="createDir">Directory</label>
        <select id="createDir" name="directory"><option value="">Loading directories&hellip;</option></select>
      </div>
      <div class="form-group">
        <label for="createLeft">Left pane command (optional)</label>
        <input type="text" id="createLeft" name="leftCmd" placeholder="nvim" autocomplete="off" spellcheck="false">
      </div>
      <div class="form-group">
        <label for="createRight">Right pane command (optional)</label>
        <input type="text" id="createRight" name="rightCmd" placeholder="claude" autocomplete="off" spellcheck="false">
      </div>
      <button class="btn primary" id="btnCreate">Create Session</button>
    </div>
  </section>
  <section class="tab-content" id="tab-spawn" role="tabpanel" aria-labelledby="tab-spawn-label">
    <h2 class="visually-hidden" id="tab-spawn-label">Spawn Agents</h2>
    <div class="form-panel">
      <h3>Spawn Agents</h3>
      <div class="form-group">
        <label for="spawnDir">Project directory</label>
        <select id="spawnDir" name="spawnDirectory"><option value="">Loading directories&hellip;</option></select>
        <div class="form-hint">The git repo where agents will create worktrees</div>
      </div>
      <div class="form-group">
        <label id="taskListLabel">Tasks</label>
        <div class="task-list" id="taskList" aria-labelledby="taskListLabel">
          <div class="task-row" data-idx="0">
            <span class="task-num">1</span>
            <textarea placeholder="Describe the task for this agent&hellip;" rows="2"></textarea>
            <button class="btn-remove" aria-label="Remove task" title="Remove task" onclick="tspSpawn.removeTask(0)">&times;</button>
          </div>
        </div>
        <button class="add-task-btn" onclick="tspSpawn.addTask()">+ Add another task</button>
      </div>
      <div class="form-group">
        <label for="spawnBase">Base branch (optional)</label>
        <input type="text" id="spawnBase" name="baseBranch" placeholder="main" autocomplete="off" spellcheck="false">
      </div>
      <div class="form-group" style="display:flex;align-items:center;gap:8px;">
        <input type="checkbox" id="spawnNoInstall" name="noInstall">
        <label for="spawnNoInstall" style="margin:0">Skip dependency install</label>
      </div>
      <button class="btn primary" id="btnSpawn">Spawn Agents</button>
      <div id="spawnResults" aria-live="polite"></div>
    </div>
  </section>
</main>
<div id="pairingScreen" style="display:none;">
  <div class="pairing-wrapper">
    <div class="pairing-panel">
      <div class="form-panel">
        <h2 class="pairing-title">Device Pairing</h2>
        <p class="pairing-subtitle">Run <code>tsp device pair</code> in your terminal, then enter the 6-character code below.</p>
        <div class="form-group">
          <label for="pairingCode" class="visually-hidden">Pairing code</label>
          <input type="text" id="pairingCode" name="pairingCode" class="pairing-code-input" placeholder="A7K2M9" maxlength="6" spellcheck="false" autocomplete="off" autocapitalize="characters" inputmode="text">
        </div>
        <button class="btn primary pairing-btn" id="btnPair">Pair Device</button>
        <p id="pairingError" class="pairing-error" aria-live="assertive"></p>
      </div>
    </div>
  </div>
</div>
<div class="toast-container" id="toasts" aria-live="polite" role="status"></div>
<script>
(function() {
  "use strict";

  var sessions = [];
  var expandedSessions = new Set();
  var ws = null;
  var wsRetryMs = 1000;
  var configDirs = [];
  var renderPending = false;
  var API = window.location.origin;
  var authToken = localStorage.getItem("tsp_token") || "";

  function $(sel) { return document.querySelector(sel); }
  function $$(sel) { return document.querySelectorAll(sel); }
  function esc(s) {
    var d = document.createElement("div");
    d.textContent = s || "";
    return d.innerHTML;
  }

  function toast(msg, type) {
    type = type || "info";
    var el = document.createElement("div");
    el.className = "toast " + type;
    el.textContent = msg;
    $("#toasts").appendChild(el);
    setTimeout(function() { el.remove(); }, 4000);
  }

  async function api(method, path, body) {
    var opts = { method: method, headers: {} };
    if (authToken) {
      opts.headers["Authorization"] = "Bearer " + authToken;
    }
    if (body !== undefined) {
      opts.headers["Content-Type"] = "application/json";
      opts.body = JSON.stringify(body);
    }
    var resp = await fetch(API + path, opts);
    var data = await resp.json();
    if (resp.status === 401) {
      localStorage.removeItem("tsp_token");
      authToken = "";
      showPairingScreen();
      throw new Error("Authentication required");
    }
    if (!resp.ok) throw new Error(data.error || ("HTTP " + resp.status));
    return data;
  }

  function showPairingScreen() {
    $("#pairingScreen").style.display = "block";
    $("header").style.display = "none";
    $("main").style.display = "none";
    if (ws) { ws.close(); ws = null; }
  }

  function showDashboard() {
    $("#pairingScreen").style.display = "none";
    $("header").style.display = "";
    $("main").style.display = "";
    fetchHealth();
    loadDirectories();
    connectWS();
  }

  $("#btnPair").addEventListener("click", async function() {
    var code = $("#pairingCode").value.trim().toUpperCase();
    if (code.length !== 6) {
      $("#pairingError").textContent = "Enter the 6-character code";
      $("#pairingError").style.display = "block";
      return;
    }
    $("#btnPair").disabled = true;
    $("#btnPair").textContent = "Pairing\u2026";
    $("#pairingError").style.display = "none";
    try {
      var resp = await fetch(API + "/api/pair/complete", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ code: code, name: "Web Browser" })
      });
      var data = await resp.json();
      if (!resp.ok) {
        throw new Error(data.error || "Pairing failed");
      }
      authToken = data.token;
      localStorage.setItem("tsp_token", authToken);
      showDashboard();
    } catch(e) {
      $("#pairingError").textContent = e.message;
      $("#pairingError").style.display = "block";
    } finally {
      $("#btnPair").disabled = false;
      $("#btnPair").textContent = "Pair Device";
    }
  });

  $("#pairingCode").addEventListener("keydown", function(e) {
    if (e.key === "Enter") { $("#btnPair").click(); }
  });

  function timeAgo(iso) {
    if (!iso) return "";
    var sec = Math.floor((Date.now() - new Date(iso).getTime()) / 1000);
    if (sec < 60) return sec + "s ago";
    if (sec < 3600) return Math.floor(sec / 60) + "m ago";
    return Math.floor(sec / 3600) + "h ago";
  }

  function userInteracting() {
    var active = document.activeElement;
    if (!active || active === document.body) return false;
    var grid = $("#sessionGrid");
    return grid && grid.contains(active);
  }

  $$(".tab").forEach(function(btn) {
    btn.addEventListener("click", function() {
      $$(".tab").forEach(function(t) { t.classList.remove("active"); });
      $$(".tab-content").forEach(function(c) { c.classList.remove("active"); });
      btn.classList.add("active");
      $("#tab-" + btn.dataset.tab).classList.add("active");
    });
  });

  async function loadDirectories() {
    try {
      var data = await api("GET", "/api/directories");
      configDirs = data.directories || [];
      populateDirSelects();
    } catch(e) {}
  }

  function populateDirSelects() {
    var selectors = [$("#createDir"), $("#spawnDir")];
    selectors.forEach(function(sel) {
      if (!sel) return;
      sel.innerHTML = "";
      if (configDirs.length === 0) {
        sel.innerHTML = '<option value="">No directories found</option>';
        return;
      }
      configDirs.forEach(function(d) {
        var opt = document.createElement("option");
        opt.value = d;
        var parts = d.split("/");
        opt.textContent = parts.length > 2 ? parts.slice(-2).join("/") : d;
        sel.appendChild(opt);
      });
    });
  }

  if (authToken) {
    showDashboard();
  } else {
    showPairingScreen();
  }

  async function fetchHealth() {
    try {
      var data = await api("GET", "/api/health");
      $("#healthTmux").className = "health-dot " + (data.tmux ? "ok" : "fail");
      $("#healthGh").className = "health-dot " + (data.gh ? "ok" : "fail");
    } catch(e) {
      $("#healthTmux").className = "health-dot fail";
      $("#healthGh").className = "health-dot fail";
    }
  }
  setInterval(function() { if (authToken) fetchHealth(); }, 15000);

  function connectWS() {
    if (!authToken) return;
    var proto = location.protocol === "https:" ? "wss:" : "ws:";
    ws = new WebSocket(proto + "//" + location.host + "/api/ws?token=" + encodeURIComponent(authToken));
    ws.onopen = function() {
      $("#wsDot").className = "ws-dot connected";
      $("#wsLabel").textContent = "live";
      wsRetryMs = 1000;
    };
    ws.onmessage = function(ev) {
      try {
        var msg = JSON.parse(ev.data);
        if (msg.sessions) {
          sessions = msg.sessions;
          if (userInteracting()) {
            renderPending = true;
          } else {
            renderSessions();
            renderPending = false;
          }
        }
      } catch(e) {}
    };
    ws.onclose = function() {
      $("#wsDot").className = "ws-dot disconnected";
      $("#wsLabel").textContent = "reconnecting";
      setTimeout(connectWS, wsRetryMs);
      wsRetryMs = Math.min(wsRetryMs * 2, 10000);
    };
    ws.onerror = function() { ws.close(); };
  }

  document.addEventListener("focusout", function() {
    setTimeout(function() {
      if (renderPending && !userInteracting()) {
        renderSessions();
        renderPending = false;
      }
    }, 100);
  });

  function renderSessions() {
    var grid = $("#sessionGrid");
    var empty = $("#emptyState");

    if (!sessions || sessions.length === 0) {
      grid.innerHTML = "";
      empty.style.display = "block";
      return;
    }
    empty.style.display = "none";

    var html = "";
    sessions.forEach(function(s) {
      var expanded = expandedSessions.has(s.name);
      var statusClass = s.status || "active";
      var paneCount = s.panes ? s.panes.length : 0;

      html += '<div class="session-card' + (expanded ? " expanded" : "") + '" data-name="' + esc(s.name) + '">';
      html += '<div class="session-header" data-toggle="' + esc(s.name) + '" role="button" tabindex="0" aria-expanded="' + expanded + '">';
      html += '<div class="session-left">';
      html += '<span class="status-dot ' + statusClass + '" aria-hidden="true"></span>';
      html += '<span class="session-name">' + esc(s.name) + '</span>';
      html += '<span class="visually-hidden"> \u2014 ' + esc(statusClass) + '</span>';
      html += '</div>';
      html += '<div class="session-meta">';
      if (s.branch) html += '<span class="branch">' + esc(s.branch) + '</span>';
      html += '<span>' + paneCount + ' pane' + (paneCount !== 1 ? "s" : "") + '</span>';
      html += '<span>' + timeAgo(s.lastChanged) + '</span>';
      html += '<span style="text-transform:capitalize;">' + esc(statusClass) + '</span>';
      html += '</div></div>';

      html += '<div class="session-detail">';
      html += '<div class="detail-grid">';

      html += '<div class="detail-section"><h4>Panes</h4><div class="pane-list">';
      if (s.panes) {
        s.panes.forEach(function(p) {
          html += '<div class="pane-item">';
          html += '<span><span class="pane-type">' + esc(p.type) + '</span> (pane ' + p.index + ')</span>';
          html += '<span class="pane-process">' + esc(p.process || "-") + '</span>';
          html += '</div>';
        });
      }
      html += '</div></div>';

      html += '<div class="detail-section"><h4>Git / PR</h4>';
      html += '<div class="pr-info">';
      if (s.pr) {
        html += '<a href="' + esc(s.pr.url) + '" target="_blank" rel="noopener">PR #' + s.pr.number + '</a>';
        html += '<div class="pr-detail">CI: ' + esc(s.pr.ciStatus || "unknown") + ' | Reviews: ' + (s.pr.reviewCount || 0) + '</div>';
      } else if (s.branch) {
        html += '<span style="color:var(--text-dim)">No PR yet</span>';
      } else {
        html += '<span style="color:var(--text-dim)">Not a git repo</span>';
      }
      html += '</div>';
      if (s.diff) {
        html += '<div class="diff-stats">';
        html += '<span class="diff-files">' + s.diff.files + ' file' + (s.diff.files !== 1 ? "s" : "") + '</span>';
        html += '<span class="diff-ins">+' + s.diff.insertions + '</span>';
        html += '<span class="diff-del">-' + s.diff.deletions + '</span>';
        html += '</div>';
      }
      html += '</div></div>';

      html += '<div class="actions-row">';
      html += '<button class="btn" onclick="tspActions.getPR(\'' + esc(s.name) + '\')">Get PR</button>';
      html += '<button class="btn" onclick="tspActions.createPR(\'' + esc(s.name) + '\')">Create PR</button>';
      html += '<button class="btn" onclick="tspActions.fixCI(\'' + esc(s.name) + '\')">Fix CI</button>';
      html += '<button class="btn" onclick="tspActions.fixReviews(\'' + esc(s.name) + '\')">Fix Reviews</button>';
      html += '<button class="btn" onclick="tspActions.merge(\'' + esc(s.name) + '\')">Merge PR</button>';
      html += '<button class="btn danger" onclick="tspActions.deleteSession(\'' + esc(s.name) + '\')">Delete</button>';
      html += '</div>';

      html += '<div class="send-row">';
      html += '<select data-pane-sel="' + esc(s.name) + '" aria-label="Target pane for ' + esc(s.name) + '">';
      if (s.panes) {
        s.panes.forEach(function(p) {
          html += '<option value="' + p.index + '">Pane ' + p.index + ' (' + esc(p.type) + ')</option>';
        });
      }
      html += '</select>';
      html += '<input type="text" data-cmd-input="' + esc(s.name) + '" aria-label="Command for ' + esc(s.name) + '" placeholder="Send command\u2026" spellcheck="false" onkeydown="if(event.key===\'Enter\'){event.stopPropagation();tspActions.sendCmd(\'' + esc(s.name) + '\')}">';
      html += '<button class="btn primary btn-sm" onclick="tspActions.sendCmd(\'' + esc(s.name) + '\')">Send</button>';
      html += '</div>';

      html += '</div></div>';
    });

    grid.innerHTML = html;

    $$("[data-toggle]").forEach(function(el) {
      el.addEventListener("click", function(ev) {
        if (ev.target.closest(".send-row") || ev.target.closest(".actions-row")) return;
        var name = el.dataset.toggle;
        var card = el.closest(".session-card");
        if (expandedSessions.has(name)) {
          expandedSessions.delete(name);
          card.classList.remove("expanded");
        } else {
          expandedSessions.add(name);
          card.classList.add("expanded");
          fetchSessionDetail(name);
        }
      });
      el.addEventListener("keydown", function(ev) {
        if (ev.key === "Enter" || ev.key === " ") {
          ev.preventDefault();
          el.click();
        }
      });
    });
  }

  async function fetchSessionDetail(name) {
    try {
      var data = await api("GET", "/api/sessions/" + encodeURIComponent(name));
      for (var i = 0; i < sessions.length; i++) {
        if (sessions[i].name === name) {
          sessions[i].pr = data.pr;
          sessions[i].diff = data.diff;
          break;
        }
      }
      if (!userInteracting()) renderSessions();
    } catch(e) {}
  }

  window.tspActions = {
    async getPR(name) {
      try {
        var data = await api("GET", "/api/sessions/" + encodeURIComponent(name) + "/pr");
        if (data.pr) {
          toast("PR #" + data.pr.number + " - CI: " + (data.pr.ciStatus || "unknown"), "success");
        } else {
          toast("No PR found for " + name, "info");
        }
        fetchSessionDetail(name);
      } catch(e) { toast(e.message, "error"); }
    },

    async createPR(name) {
      try {
        var data = await api("POST", "/api/sessions/" + encodeURIComponent(name) + "/pr");
        toast("PR created: " + data.url, "success");
        fetchSessionDetail(name);
      } catch(e) { toast(e.message, "error"); }
    },

    async fixCI(name) {
      try {
        await api("POST", "/api/sessions/" + encodeURIComponent(name) + "/fix-ci");
        toast("Fix CI prompt sent to " + name, "success");
      } catch(e) { toast(e.message, "error"); }
    },

    async fixReviews(name) {
      try {
        await api("POST", "/api/sessions/" + encodeURIComponent(name) + "/fix-reviews");
        toast("Review comments sent to " + name, "success");
      } catch(e) { toast(e.message, "error"); }
    },

    async merge(name) {
      if (!confirm("Merge PR for session \"" + name + "\"?")) return;
      try {
        await api("POST", "/api/sessions/" + encodeURIComponent(name) + "/merge");
        toast("PR merged for " + name, "success");
      } catch(e) { toast(e.message, "error"); }
    },

    async deleteSession(name) {
      if (!confirm("Delete session \"" + name + "\"? This cannot be undone.")) return;
      try {
        await api("DELETE", "/api/sessions/" + encodeURIComponent(name), { cleanupWorktree: true });
        toast("Session " + name + " deleted", "success");
        expandedSessions.delete(name);
      } catch(e) { toast(e.message, "error"); }
    },

    async sendCmd(name) {
      var paneSel = document.querySelector('[data-pane-sel="' + name + '"]');
      var cmdInput = document.querySelector('[data-cmd-input="' + name + '"]');
      if (!cmdInput || !cmdInput.value.trim()) return;
      var pane = paneSel ? parseInt(paneSel.value, 10) : 0;
      var text = cmdInput.value.trim();
      try {
        await api("POST", "/api/sessions/" + encodeURIComponent(name) + "/send", { pane: pane, text: text });
        toast("Sent to " + name + " pane " + pane, "success");
        cmdInput.value = "";
      } catch(e) { toast(e.message, "error"); }
    }
  };

  $("#btnCreate").addEventListener("click", async function() {
    var name = $("#createName").value.trim();
    var dir = $("#createDir").value;
    var leftCmd = $("#createLeft").value.trim();
    var rightCmd = $("#createRight").value.trim();
    if (!name || !dir) {
      toast("Name and directory are required", "error");
      return;
    }
    try {
      await api("POST", "/api/sessions", { name: name, dir: dir, leftCmd: leftCmd, rightCmd: rightCmd });
      toast("Session " + name + " created", "success");
      $("#createName").value = "";
      $("#createLeft").value = "";
      $("#createRight").value = "";
      $$(".tab")[0].click();
    } catch(e) { toast(e.message, "error"); }
  });

  var taskCounter = 1;

  window.tspSpawn = {
    addTask: function() {
      var list = $("#taskList");
      var idx = taskCounter++;
      var row = document.createElement("div");
      row.className = "task-row";
      row.dataset.idx = idx;
      row.innerHTML =
        '<span class="task-num">' + (list.children.length + 1) + '</span>' +
        '<textarea placeholder="Describe the task for this agent\u2026" rows="2"></textarea>' +
        '<button class="btn-remove" aria-label="Remove task" title="Remove task" onclick="tspSpawn.removeTask(' + idx + ')">&times;</button>';
      list.appendChild(row);
      row.querySelector("textarea").focus();
      tspSpawn.renumber();
    },

    removeTask: function(idx) {
      var list = $("#taskList");
      if (list.children.length <= 1) return;
      var row = list.querySelector('[data-idx="' + idx + '"]');
      if (row) row.remove();
      tspSpawn.renumber();
    },

    renumber: function() {
      var rows = $$("#taskList .task-row");
      rows.forEach(function(row, i) {
        row.querySelector(".task-num").textContent = i + 1;
      });
    },

    getTasks: function() {
      var tasks = [];
      $$("#taskList textarea").forEach(function(ta) {
        var v = ta.value.trim();
        if (v) tasks.push(v);
      });
      return tasks;
    }
  };

  $("#btnSpawn").addEventListener("click", async function() {
    var tasks = tspSpawn.getTasks();
    if (tasks.length === 0) {
      toast("Add at least one task", "error");
      return;
    }
    var base = $("#spawnBase").value.trim() || "";
    var dir = $("#spawnDir").value || "";
    var noInstall = $("#spawnNoInstall").checked;

    if (!dir) {
      toast("Select a project directory", "error");
      return;
    }

    var btn = $("#btnSpawn");
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span>Spawning ' + tasks.length + ' agent' + (tasks.length > 1 ? 's' : '') + '\u2026';

    try {
      var data = await api("POST", "/api/spawn", { tasks: tasks, base: base, dir: dir, noInstall: noInstall });
      var results = data.results || [];
      toast(results.length + " agent(s) spawned", "success");

      var resHtml = '<div class="spawn-results"><h4>Spawn Results</h4>';
      results.forEach(function(r) {
        resHtml += '<div class="spawn-result-item">';
        resHtml += '<span class="result-status ' + (r.status === "ok" ? "ok" : "error") + '"></span>';
        resHtml += '<span class="result-task">' + esc(r.task) + '</span>';
        if (r.status === "ok") {
          resHtml += '<span class="result-branch">' + esc(r.branch) + '</span>';
          resHtml += '<span class="result-session">' + esc(r.session) + '</span>';
        } else {
          resHtml += '<span class="result-error">' + esc(r.error) + '</span>';
        }
        resHtml += '</div>';
      });
      resHtml += '</div>';
      $("#spawnResults").innerHTML = resHtml;

      var list = $("#taskList");
      list.innerHTML =
        '<div class="task-row" data-idx="0">' +
        '<span class="task-num">1</span>' +
        '<textarea placeholder="Describe the task for this agent\u2026" rows="2"></textarea>' +
        '<button class="btn-remove" aria-label="Remove task" title="Remove task" onclick="tspSpawn.removeTask(0)">&times;</button>' +
        '</div>';
      taskCounter = 1;
    } catch(e) { toast(e.message, "error"); }
    finally {
      btn.disabled = false;
      btn.textContent = "Spawn Agents";
    }
  });

})();
</script>
</body>
</html>
